<!DOCTYPE html> <html lang= "en"> <head> <meta charset= "utf-8"/> <meta name=
"viewport" content= "width=device-width, initial-scale=1" />

<script src="https://d3js.org/d3.v7.min.js"></script> <!-- d3 import -->
<script src="http://d3js.org/topojson.v1.min.js"></script>

<title>INFO 3300 Project 2 </title> </head>

<body><p id="p1">
  <h1> Visualization 1 </h1>

  <svg id= "map" height="700" width="800" />
  <svg id= "countryChart" height="500" width="500" />

  <script>

      const drawMap = async () => {

      // Initialize datasets
      const worldmap = await d3.json("countries-50m.json");
      const happinessreport = await d3.csv("2019.csv");

      ////////////////////////// Data Cleaning /////////////////////////////////
      // List of names that need to be manually matched between datasets

      happinessreport[18]["Country or region"] = "United States of America" // "United States"
      happinessreport[19]["Country or region"] = "Czechia" // "Czech Republic"
      happinessreport[38]["Country or region"] = "Trinidad and Tobago" // "Trinidad & Tobago"
      happinessreport[76]["Country or region"] = "Dominican Rep." // "Dominican Republic"
      happinessreport[77]["Country or region"] = "Bosnia and Herz." // "Bosnia and Herzegovina"
      happinessreport[102]["Country or region"] = "Congo" // "Congo (Brazzaville)"
      happinessreport[109]["Country or region"] = "Palestine" // "Palestinian Territories"
      happinessreport[126]["Country or region"] = "Dem. Rep. Congo" // "Congo (Kinshasha)"
      happinessreport[134]["Country or region"] = "eSwatini" // "Swaziland"
      happinessreport[154]["Country or region"] = "Central African Rep." // "Central African Republic"
      happinessreport[155]["Country or region"] = "S. Sudan" // "South Sudan"

      // Places to drop from happiness report
      //happinessreport[63]["Country or region"] = "-" // "Northern Cyprus" --> Cyprus
      //happinessreport[83]["Country or region"] = "-" // "North Macedonia" --> Macedonia?
      //happinessreport[98]["Country or region"] = "-" // "Ivory Coast" --> drop?

      // Worldmap country names list
      worldmap_names = [];
      worldmap.objects.countries.geometries.forEach( (d, i) => {
        worldmap_names.push(d.properties.name);
      });

      // Happinessreport country names list
      happiness_names = [];
      happinessreport.forEach( (d, i) => {
        happiness_names.push(d["Country or region"]);
      });

      const names_to_fix = happiness_names.filter(element => !worldmap_names.includes(element));
      console.log(names_to_fix);

      //////////////////////////////////////////////////////////////////////////

      // Initialize constants for map generation
      const countries = topojson.feature(worldmap, worldmap.objects.countries);
      const countriesMesh = topojson.mesh(worldmap, worldmap.objects.countries);
      const landMesh = topojson.mesh(worldmap, worldmap.objects.land);

      let map = d3.select("svg#map");
      let mapWidth = map.attr("width");
      let mapHeight = map.attr("height");
      let projection = d3.geoMercator().fitSize([mapWidth, mapHeight], countries);
      let path = d3.geoPath().projection(projection);

      let viewport = map.append("g"); // g tag for map elements

      // Draw countries and their mesh lines
      let mycountries = viewport.selectAll(".countries").data(countries.features)
              .enter()
              .append("path")
              .attr("class","countries")
              .attr("d", path)
              .attr("fill", "gray"); // CHANGE BASED ON HAPPINESS DATA

      country_lines = viewport.append("path").datum(countriesMesh)
                              .attr("class","country-outline")
                              .attr("d", path)
                              .attr("fill" ,"none")
                              .attr("stroke", "black")
                              .attr("stroke-width", 0.5);

      // Draw land mesh lines
      land_lines = viewport.append("path").datum(landMesh)
                           .attr("class","land-outline")
                           .attr("d", path)
                           .attr("fill" ,"none")
                           .attr("stroke", "black")
                           .attr("stroke-width", 0.75);

      // Zoom Generator
      var zoom = d3.zoom()
                   .scaleExtent([1,10])
                   .translateExtent([[-50,-50],[mapWidth+50,mapHeight+50]])  // to lock to edges
                   .on("zoom", mapZoom);

      map.call(zoom);
      map.call(zoom.transform, d3.zoomIdentity);

      function mapZoom({transform}) {
        // Transform the group object to reflect the zoom action
        viewport.attr("transform", transform.toString());

        // Modify the stroke-width of the mesh so the width remains the same regardless of the zoom level
        viewport.select(".county-outline")
                .style("stroke-width", 0.5 / transform.k);
        viewport.select(".state-outline")
                .style("stroke-width", 0.75 / transform.k);
        }

      console.log(happinessreport);

      // ---- Country Chart Set Up ----
      const svg_country = d3.select("svg#countryChart");
      const width = svg_country.attr("width");
      const height = svg_country.attr("height");
      const margin = {top: 10, right: 10, bottom: 10, left: 10};
      const chartWidth = width - margin.left - margin.right;
      const chartHeight = height - margin.top - margin.bottom;

      let annotations = svg_country.append("g").attr("id","annotations");
      let chartArea = svg_country.append("g").attr("id","points")
                      .attr("transform",`translate(${margin.left},${margin.top})`);

      let name = chartArea.append("text")
          .style("opacity", "0")

      // PIE CHART
      var data = [10, 5, 4, 6];
      //var data = [freedom, gdp, generosity, life_expectancy, corruption, social_support];
      var radius = 50;
      var color = d3.scaleOrdinal(['#4daf4a','#377eb8','#ff7f00','#984ea3']);
      var pie = d3.pie();
      var arc = d3.arc()
                .innerRadius(10)
                .outerRadius(radius);
      var arcs = chartArea.selectAll("arc")
                .data(pie(data))
                .enter()
                .append("g")
                .attr("class", "arc")
                .attr("transform",`translate(${radius},${radius})`);

        arcs.append("path")
          .attr("fill", function(d, i) {
              return color(i);
          })
          .attr("d", arc);

      // Mouseover Functions
      mycountries.on("mouseover", function() {
        name.text(d3.select(this).datum().properties.name)
          .style("opacity", "1")

        happinessreport.forEach( (d, i) => {
          if(d["Country or region"] == d3.select(this).datum().properties.name){
            let rank = d["Overall rank"];
            let freedom = d["Freedom to make life choices"];
            let gdp = d["GDP per capita"];
            let generosity = d["Generosity"];
            let life_expectancy = d["Healthy life expectancy"];
            let corruption = d["Perceptions of corruption"];
            let social_support = d["Social support"];
            let score = d["Score"];
          }
        });

      });

      mycountries.on("mouseout", function() {
        name.style("opacity", "0")

      });

    } // end of async function

    drawMap();


    </script>

  </p></body>
